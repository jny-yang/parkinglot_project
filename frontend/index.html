<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>æ™ºæ…§åœè»Šç³»çµ±</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #f8fafc;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 { margin-bottom: 20px; }
    #parking-lot {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      grid-template-rows: repeat(5, 60px);
      gap: 6px;
      justify-content: center;
      margin: 20px auto;
    }
    .slot {
      width: 60px;
      height: 60px;
      background: #334155;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: white;
      transition: background 0.3s ease;
      position: relative;
    }
    .empty { background: #475569; }
    .car { background: #22c55e; font-weight: bold; }
    .path { background: #3b82f6 !important; }
    .entrance { background: #facc15; color: #000; font-weight: bold; }
    .moving-car {
      width: 100%;
      height: 100%;
      background: red;
      border-radius: 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      animation: blink 0.3s infinite alternate;
    }
    @keyframes blink {
      from { opacity: 1; }
      to { opacity: 0.6; }
    }
    .controls { margin-top: 20px; }
    input {
      padding: 6px;
      border-radius: 6px;
      border: none;
      margin-right: 8px;
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #3b82f6;
      color: white;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:hover { background: #2563eb; }
  </style>
</head>
<body>
  <h1>æ™ºæ…§åœè»Šç³»çµ± ğŸš—</h1>
  <div id="parking-lot"></div>
  <div class="controls">
    <input type="text" id="plate" placeholder="è¼¸å…¥è»Šç‰Œè™Ÿç¢¼">
    <button onclick="parkCar()">åœè»Š</button>
    <button onclick="takeCar()">å–è»Š</button>
  </div>

  <script>
    const ROWS = 5, COLS = 5;
    const entrance = [4, 2]; // å‡ºå…¥å£å›ºå®š
    let parkingLot = [];

    async function fetchStatus() {
      const res = await fetch('/status');
      parkingLot = await res.json();
      renderLot();
    }

    function renderLot(path = [], movingPlate = null) {
      const lotDiv = document.getElementById("parking-lot");
      lotDiv.innerHTML = "";
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const div = document.createElement("div");
          div.classList.add("slot");

          if (r === entrance[0] && c === entrance[1]) {
            div.classList.add("entrance");
            div.textContent = "ğŸšª";
          } else if (parkingLot[r][c]) {
            div.classList.add("car");
            div.textContent = parkingLot[r][c];
          } else {
            div.classList.add("empty");
          }

          // è·¯å¾‘é¡¯ç¤º
          if (path.some(([pr, pc]) => pr === r && pc === c)) {
            div.classList.add("path");
          }

          // ç§»å‹•ä¸­çš„è»Šå­é¡¯ç¤º
          if (movingPlate && path.length > 0) {
            const [cr, cc] = path[0];
            if (r === cr && c === cc) {
              const carDiv = document.createElement("div");
              carDiv.classList.add("moving-car");
              carDiv.textContent = movingPlate;
              div.innerHTML = "";
              div.appendChild(carDiv);
            }
          }

          lotDiv.appendChild(div);
        }
      }
    }

    // è»Šå­å‹•ç•«ï¼šä¾åºç¶“é path
    async function animateCar(path, plate, finalUpdate) {
      for (let i = 0; i < path.length; i++) {
        renderLot(path.slice(0, i+1), plate);
        await new Promise(res => setTimeout(res, 500)); // ç§»å‹•é€Ÿåº¦
      }
      // æœ€å¾Œæ›´æ–°åœè»Šå ´ç‹€æ…‹
      parkingLot = finalUpdate;
      renderLot();
    }

    async function parkCar() {
      const plate = document.getElementById("plate").value.trim();
      if (!plate) return alert("è«‹è¼¸å…¥è»Šç‰Œè™Ÿç¢¼");
      const res = await fetch('/park', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ plate })
      });
      const data = await res.json();
      if (!data.success) {
        alert(data.message);
      } else {
        await animateCar(data.path, plate, data.slots);
      }
    }

    async function takeCar() {
      const plate = document.getElementById("plate").value.trim();
      if (!plate) return alert("è«‹è¼¸å…¥è»Šç‰Œè™Ÿç¢¼");
      const res = await fetch('/take', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ plate })
      });
      const data = await res.json();
      if (!data.success) {
        alert(data.message);
      } else {
        await animateCar(data.path, plate, data.slots);
      }
    }

    fetchStatus();
  </script>
</body>
</html>
